<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Historical Data Downloader (Select Time Zone)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .download-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Download Last 24 Hours of Historical Data (15-minute Intervals)</h1>

    <!-- Dropdown to select time zone -->
    <label for="time-zone">Select Time Zone:</label>
    <select id="time-zone">
        <option value="Asia/Kuwait" selected>Kuwait (UTC+3)</option>
        <option value="Asia/Kolkata">India (UTC+5:30)</option>
        <option value="Asia/Karachi">Pakistan (UTC+5)</option>
        <option value="Asia/Dhaka">Bangladesh (UTC+6)</option>
    </select>

    <!-- Table to show the historical data -->
    <table id="data-table">
        <thead>
            <tr>
                <th>Asset</th>
                <th>Datetime (Local Time)</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
            </tr>
        </thead>
        <tbody id="data-body">
            <!-- Data will be inserted here -->
        </tbody>
    </table>

    <!-- Button to download the historical data -->
    <a id="download-link" class="download-link" download="historical_data_15min.csv" href="#">Download CSV</a>

    <script>
        const apiKey = '6ecda4d1ff2c4f0b91b7ddf7d7140721';  // Your Twelve Data API Key
        const symbols = ['XAU/USD', 'BTC/USD', 'USD/JPY', 'USD/INR', 'EUR/USD'];  // List of assets

        // Function to fetch historical data for the last 24 hours (15-minute intervals)
        async function fetchHistoricalData(symbol) {
            const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=15min&outputsize=96&apikey=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.values) {
                return data.values;  // Return the 24 hours of data in 15-minute intervals
            } else {
                console.error(`Error fetching data for ${symbol}:`, data);
                return [];
            }
        }

        // Function to convert UTC time to the selected time zone
        function convertToLocalTime(utcTime, timeZone) {
            const utcDate = new Date(utcTime.replace(' ', 'T') + 'Z');  // Convert UTC time to ISO format
            return utcDate.toLocaleString('en-GB', { timeZone: timeZone, hour12: false });  // Convert to selected time zone
        }

        // Function to render the data in the table
        function renderTable(data, timeZone) {
            const dataBody = document.getElementById('data-body');
            dataBody.innerHTML = '';  // Clear existing data

            data.forEach(item => {
                const row = `<tr>
                    <td>${item.symbol}</td>
                    <td>${convertToLocalTime(item.datetime, timeZone)}</td>
                    <td>${item.open}</td>
                    <td>${item.high}</td>
                    <td>${item.low}</td>
                    <td>${item.close}</td>
                </tr>`;
                dataBody.innerHTML += row;
            });
        }

        // Function to convert the data to CSV format
        function convertToCSV(data) {
            const csvRows = [];
            csvRows.push(['Asset', 'Datetime (Local Time)', 'Open', 'High', 'Low', 'Close'].join(','));  // CSV header

            data.forEach(item => {
                csvRows.push([item.symbol, item.datetime, item.open, item.high, item.low, item.close].join(','));
            });

            return csvRows.join('\n');
        }

        // Function to create a CSV file and allow downloading
        function downloadCSV(data) {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.getElementById('download-link');
            downloadLink.href = url;
        }

        // Main function to fetch data for all symbols and process it
        async function getAllHistoricalData() {
            let allData = [];
            const timeZone = document.getElementById('time-zone').value;  // Get selected time zone

            for (const symbol of symbols) {
                const data = await fetchHistoricalData(symbol);
                const formattedData = data.map(item => ({
                    symbol: symbol,
                    datetime: convertToLocalTime(item.datetime, timeZone),  // Keep the original UTC time and convert for display
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close
                }));
                allData = allData.concat(formattedData);  // Add to the combined data
            }

            renderTable(allData, timeZone);  // Display data in the table
            downloadCSV(allData);  // Prepare CSV download link
        }

        // Fetch data when the page loads
        getAllHistoricalData();

        // Fetch new data whenever the time zone is changed
        document.getElementById('time-zone').addEventListener('change', getAllHistoricalData);
    </script>
</body>
</html>
